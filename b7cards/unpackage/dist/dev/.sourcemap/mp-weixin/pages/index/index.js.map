{"version":3,"file":"index.js","sources":["pages/index/index.vue","../../down load/HBuilderX.4.76.2025082103/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvaW5kZXgvaW5kZXgudnVl"],"sourcesContent":["<template>\r\n\t<view class=\"content\">\r\n\t\t<image class=\"logo\" src=\"/static/logo.png\"></image>\r\n\t\t<view class=\"text-area\">\r\n\t\t\t<text class=\"title\">{{title}} 当前设备分配id:{{myDeviceId}}</text>\r\n\t\t</view>\r\n\t\t\r\n\t\t<view class=\"status\">\r\n\t\t\t\t\t<text>连接状态: {{connectionStatus}}</text>\r\n\t\t\t\t</view>\r\n\t\t<button @click=\"connectWebSocket\" :disabled=\"isConnected\">\r\n\t\t\t\t\t连接WebSocket\r\n\t\t</button>\r\n\t\t<button @click=\"sendWebSocket\" :disabled=\"!isConnected\">\r\n\t\t\t发送WebSocket消息\r\n\t\t</button>\r\n\t\t<button @click=\"closeWebSocket\" :disabled=\"!isConnected\">\r\n\t\t\t关闭连接\r\n\t\t</button>\r\n\t\t<button @click=\"cleardebug\"> 清空日志 </button>\r\n\t</view>\r\n\t<view class=\"message-area\">\r\n\t\t\t\t<text class=\"sub-title\">收到的消息:</text>\r\n\t\t\t\t<scroll-view class=\"message-list\" scroll-y>\r\n\t\t\t\t\t<view v-for=\"(msg, index) in messages\" :key=\"index\" class=\"message-item\">\r\n\t\t\t\t\t\t<text>{{msg}}</text>\r\n\t\t\t\t\t</view>\r\n\t\t\t\t</scroll-view>\r\n\t</view>\r\n</template>\r\n\r\n<script>\r\n\tconst app  = getApp();\r\n\texport default {\r\n\t\t\r\n\t\tdata() {\r\n\t\t\treturn {\r\n\t\t\t\ttitle: '测试websocket控制台',\r\n\t\t\t\t//const ws = new WebSocket(\"ws://localhost:8080\")\r\n\t\t\t\tconnectionStatus: '未连接',\r\n\t\t\t\tisConnected: false,\r\n\t\t\t\tsocketTask: null,\r\n\t\t\t\tmessages: [],\r\n\t\t\t\treconnectTimer: null,\r\n\t\t\t\treconnectCount: 0,\r\n\t\t\t\tmaxReconnectCount: 5,\r\n\t\t\t\tmyDeviceId: null,\r\n\t\t\t}\r\n\t\t},\r\n\t\tonLoad() {\r\n\r\n\t\t},\r\n\t\tmethods: {\r\n\t\t\tcleardebug(){\r\n\t\t\t\tthis.messages = [];\r\n\t\t\t},\r\n\t\t\t//连接websocket \r\n\t\t\tconnectWebSocket(){\r\n\t\t\t\t//\r\n\t\t\t\tconsole.log(\"连接websocket\")\r\n\t\t\t\tif(this.reconnectTimer){\r\n\t\t\t\t\tclearTimeout(this.reconnectTimer);\r\n\t\t\t\t\tthis.reconnectTimer = null;\r\n\t\t\t\t}\r\n\t\t\t\t// ----------------------------------------------------这里放着url\r\n\t\t\t\tconst deviceId = uni.getSystemInfoSync().deviceId || generateDeviceId();\r\n\t\t\t\tconst socketUrl = 'ws://192.168.233.118:3001?deviceId=' + deviceId;\r\n\t\t\t\tconsole.log(\"当前设备持有url\" + socketUrl);\r\n\t\t\t\tthis.socketTask = uni.connectSocket({\r\n\t\t\t\t\turl:socketUrl,\r\n\t\t\t\t\t\r\n\t\t\t\t\tsuccess: (ctx) => {\r\n\t\t\t\t\t\tthis.connectionStatus = \"连接中\"\r\n\t\t\t\t\t\tconsole.log(\"连接成功\")\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tthis.isConnected = true;\r\n\t\t\t\t\t\tthis.connectionStatus = \"已连接\"\r\n\t\t\t\t\t\tconsole.log(JSON.stringify(ctx));\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t},\r\n\t\t\t\t\tfail: (err) => {\r\n\t\t\t\t\t\tconsole.error('WebSocket连接创建失败:', err);\r\n\t\t\t\t\t\tthis.connectionStatus = '连接失败';\r\n\t\t\t\t\t\tthis.handleReconnect();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t\tthis.socketTask.onOpen((res) => {\r\n\t\t\t\t\tconsole.log(\"连接已经打开\")\r\n\t\t\t\t\tapp.globalData.isConnected = true;\r\n\t\t\t\t\tapp.globalData.socketTask = this.socketTask;\r\n\t\t\t\t\tthis.socketTask.onMessage((res) => {\r\n\t\t\t\t\t  try {\r\n\t\t\t\t\t    const data = JSON.parse(res.data);\r\n\t\t\t\t\t\t// if (data.type === 'system') {\r\n\t\t\t\t\t\t//       this.addMessage(\"单个广播\" + data.content); // 显示系统消息\r\n\t\t\t\t\t\t//     }\r\n\t\t\t\t\t\tif(data.type === 'system' && data.deviceId) {\r\n\t\t\t\t\t\t\tthis.myDeviceId = data.deviceId;\r\n\t\t\t\t\t\t\tapp.globalData.diviceid = this.myDeviceId;\r\n\t\t\t\t\t\t\tconsole.log(\"成功分配到id\" + deviceId);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t    // 显示消息时添加设备ID\r\n\t\t\t\t\t      if (data.type === 'message') {\r\n\t\t\t\t\t        let prefix = \"\";\r\n\t\t\t\t\t        if (data.deviceId === this.myDeviceId) {\r\n\t\t\t\t\t          prefix = \"[我] \";\r\n\t\t\t\t\t        } else {\r\n\t\t\t\t\t          prefix = `[设备${data.deviceId}] `;\r\n\t\t\t\t\t        }\r\n\t\t\t\t\t        \r\n\t\t\t\t\t        this.addMessage(prefix + data.content);\r\n\t\t\t\t\t      }\r\n\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t  } catch (e) {\r\n\t\t\t\t\t\tconsole.log(e);\r\n\t\t\t\t\t    this.addMessage( ` 服务器错误回复: ${res.data}`);\r\n\t\t\t\t\t  }\r\n\t\t\t\t\t});\r\n\t\t\t\t})\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t},\r\n\t\t\t// 发送WebSocket消息\r\n\t\t\tsendWebSocket() {\r\n\t\t\t\tif (this.socketTask && this.isConnected) {\r\n\t\t\t\t\tconst message = {\r\n\t\t\t\t\t\ttype: 'message',\r\n\t\t\t\t\t\tcontent: 'Hello WebSocket! ' + new Date().toLocaleTimeString(),\r\n\t\t\t\t\t\ttimestamp: Date.now()\r\n\t\t\t\t\t};\r\n\t\t\t\t\t\r\n\t\t\t\t\tthis.socketTask.send({\r\n\t\t\t\t\t\tdata: JSON.stringify(message),\r\n\t\t\t\t\t\tsuccess: () => {\r\n\t\t\t\t\t\t\t//----------在连接成功的回调中设置监听函数-------------------------\r\n\t\t\t\t\t\t\tconsole.log('消息发送成功');\r\n\t\t\t\t\t\t\tthis.addMessage( ' 发送: ' + JSON.stringify(message));\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tfail: (err) => {\r\n\t\t\t\t\t\t\tconsole.error('消息发送失败:', err);\r\n\t\t\t\t\t\t\tthis.addMessage( ' 发送失败');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t} else {\r\n\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\ttitle: 'WebSocket未连接',\r\n\t\t\t\t\t\ticon: 'none'\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t\r\n\t\t\thandleReconnect(){\r\n\t\t\t\tconsole.log(\"解决重连服务\");\r\n\t\t\t},\r\n\t\t\taddMessage(msg){\r\n\t\t\t\tthis.messages.push(msg)\r\n\t\t\t},\r\n\t\t\t// sendWebSocket(){\r\n\t\t\t// \tconsole.log(\"发送消息给websocket服务\");\r\n\t\t\t// \tif (this.socketTask && this.isConnected) {\r\n\t\t\t// \t\tconst message = {\r\n\t\t\t// \t\t\ttype: 'message',\r\n\t\t\t// \t\t\tcontent: 'Hello WebSocket! ' + new Date().toLocaleTimeString(),\r\n\t\t\t// \t\t\ttimestamp: Date.now()\r\n\t\t\t// \t\t\t};\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t// \t\tthis.socketTask.send({\r\n\t\t\t// \t\t\tdata: JSON.stringify(message),\r\n\t\t\t// \t\t\tsuccess: () => {\r\n\t\t\t// \t\t\t\tconsole.log('消息发送成功');\r\n\t\t\t// \t\t\t\tthis.addMessage(' 发送成功: ' + JSON.stringify(message));\r\n\t\t\t// \t\t\t\t},\r\n\t\t\t// \t\t\tfail: (err) => {\r\n\t\t\t// \t\t\t\tconsole.error('消息发送失败:', err);\r\n\t\t\t// \t\t\t\tthis.addMessage( ' 发送失败');\r\n\t\t\t// \t\t\t\t}\r\n\t\t\t// \t\t\t});\r\n\t\t\t// \t\t\t} else {\r\n\t\t\t// \t\t\tuni.showToast({\r\n\t\t\t// \t\t\t\ttitle: 'WebSocket未连接',\r\n\t\t\t// \t\t\t\t\ticon: 'none'\r\n\t\t\t// \t\t\t\t\t});\r\n\t\t\t// \t\t\t\t\t}\r\n\t\t\t// },\r\n\t\t\tcloseWebSocket(url){\r\n\t\t\t\tif (this.socketTask) {\r\n\t\t\t\t      // 发送关闭通知给服务器\r\n\t\t\t\t\t\r\n\t\t\t\t      //关闭WebSocket连接\r\n\t\t\t\t      this.socketTask.close({\r\n\t\t\t\t\t\tcode: 1000, // 正常关闭代码\r\n\t\t\t\t\t\t  reason: JSON.stringify({ // 将消息封装为 JSON 字符串\r\n\t\t\t\t\t\t    type: 'close',\r\n\t\t\t\t\t\t    reason: 'user_request',\r\n\t\t\t\t\t\t    deviceId: this.myDeviceId\r\n\t\t\t\t\t\t  }),\r\n\r\n\t\t\t\t        success: () => {\r\n\t\t\t\t          console.log('连接已关闭');\r\n\t\t\t\t          this.socketTask = null;\r\n\t\t\t\t\t\t  this.isConnected = false;\r\n\t\t\t\t          this.addMessage('连接已关闭');\r\n\t\t\t\t        },\r\n\t\t\t\t        fail: (err) => {\r\n\t\t\t\t          console.error('关闭连接失败', err);\r\n\t\t\t\t          this.addMessage('关闭连接失败: ' + err.errMsg);\r\n\t\t\t\t        }\r\n\t\t\t\t      });\r\n\t\t\t\t    }\r\n\t\t\t\t\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n</script>\r\n\r\n<style>\r\n\t.content {\r\n\t\tdisplay: flex;\r\n\t\tflex-direction: column;\r\n\t\talign-items: center;\r\n\t\tjustify-content: center;\r\n\t}\r\n\r\n\t.logo {\r\n\t\theight: 200rpx;\r\n\t\twidth: 200rpx;\r\n\t\tmargin-top: 200rpx;\r\n\t\tmargin-left: auto;\r\n\t\tmargin-right: auto;\r\n\t\tmargin-bottom: 50rpx;\r\n\t}\r\n\r\n\t.text-area {\r\n\t\tdisplay: flex;\r\n\t\tjustify-content: center;\r\n\t}\r\n\r\n\t.title {\r\n\t\tfont-size: 36rpx;\r\n\t\tcolor: #8f8f94;\r\n\t}\r\n</style>\r\n","import MiniProgramPage from 'E:/mino7/b7cards/pages/index/index.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni","res"],"mappings":"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"}