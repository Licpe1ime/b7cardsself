# 多人游戏调试指南

## 1. 准备工作

### 1.1 服务器配置

确保服务器已正确配置 WebSocket 服务，并支持多客户端连接。以下是关键代码片段（`app.js`）：

```javascript
const clients = new Set();

app.ws.use(async(ctx) => {
  clients.add(ctx.websocket);
  
  // 广播消息给所有客户端
  function broadcast(message) {
    clients.forEach(client => {
      if (client.readyState === 1) {
        client.send(JSON.stringify(message));
      }
    });
  }
  
  // 监听消息和连接状态
  ctx.websocket.on('message', (msg) => {
    broadcast({
      type: 'message',
      content: msg.toString(),
      timestamp: Date.now()
    });
  });
});
```

### 1.2 客户端配置

在小程序端（`index.vue`）中，确保正确处理多人消息：

```javascript
this.socketTask.onMessage(res => {
  const data = JSON.parse(res.data);
  if (data.type === 'message') {
    this.addMessage(`[玩家] ${data.content}`);
  }
});
```

## 2. 多人调试步骤

### 2.1 启动服务器

```bash
cd b7cards-server
node bin/www
```

### 2.2 连接多设备
1. **获取服务器 IP**：
   ```bash
   ipconfig  # Windows
   ifconfig  # macOS/Linux
   ```
2. **手机连接同一 WiFi**，并输入服务器 IP（如 `ws://192.168.1.100:3000`）。

### 2.3 调试工具

- **模拟多客户端**：
  ```javascript
  function simulateClients(count) {
    for (let i = 0; i < count; i++) {
      const client = new WebSocket('ws://localhost:3000');
    }
  }
  ```
- **监控连接状态**：
  ```javascript
  console.log(`当前连接数: ${clients.size}`);
  ```

## 3. 常见问题排查

| 问题 | 解决方案 |
|------|----------|
| 连接失败 | 检查防火墙和端口转发 |
| 消息不同步 | 确保服务器广播逻辑正确 |
| 性能问题 | 优化消息频率和大小 |

## 4. 高级功能

- **消息追踪**：为每条消息添加唯一 ID。
- **心跳检测**：定期检查连接状态。

## 5. 注意事项

- 真机调试时需配置合法域名。
- 使用 WSS 协议确保安全性。

---

**最后更新：2025-10-23**